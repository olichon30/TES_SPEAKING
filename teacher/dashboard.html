<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ í•™ìŠµ í˜„í™© - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .stat-card .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .student-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .student-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-pale);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1rem;
        }

        .student-meta {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 2px;
        }

        .student-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .recording-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .recording-badge.has-recording {
            background: #DCFCE7;
            color: #16A34A;
        }

        .recording-badge.no-recording {
            background: #FEE2E2;
            color: #DC2626;
        }

        .last-activity {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            background: var(--bg-light);
            color: var(--text-gray);
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .filter-tab.active {
            background: var(--primary);
            color: white;
        }
    </style>
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
    <link rel="apple-touch-icon" href="../favicon.png">
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <a href="../index.html" class="back-btn"><i class="ti ti-arrow-left"></i></a>
            <h1 class="header-title">í•™ìƒ í•™ìŠµ í˜„í™©</h1>
            <button class="icon-btn" onclick="refreshData()"><i class="ti ti-refresh"></i></button>
        </header>

        <div class="content-area" style="padding-bottom: 20px;">
            <!-- Quick Menu (moved to top) -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <a href="students.html" style="text-decoration: none;">
                    <div
                        style="background: var(--bg-white); border-radius: var(--radius-lg); padding: 16px; text-align: center; box-shadow: var(--shadow-sm);">
                        <i class="ti ti-users" style="font-size: 1.5rem; color: var(--primary);"></i>
                        <p style="margin: 8px 0 0; font-size: 0.8rem; color: var(--text-dark);">í•™ìƒ ê´€ë¦¬</p>
                    </div>
                </a>
                <a href="textbooks.html" style="text-decoration: none;">
                    <div
                        style="background: var(--bg-white); border-radius: var(--radius-lg); padding: 16px; text-align: center; box-shadow: var(--shadow-sm);">
                        <i class="ti ti-book" style="font-size: 1.5rem; color: #10B981;"></i>
                        <p style="margin: 8px 0 0; font-size: 0.8rem; color: var(--text-dark);">êµì¬ ê´€ë¦¬</p>
                    </div>
                </a>
                <a href="classes.html" style="text-decoration: none;">
                    <div
                        style="background: var(--bg-white); border-radius: var(--radius-lg); padding: 16px; text-align: center; box-shadow: var(--shadow-sm);">
                        <i class="ti ti-school" style="font-size: 1.5rem; color: #8B5CF6;"></i>
                        <p style="margin: 8px 0 0; font-size: 0.8rem; color: var(--text-dark);">í•™ìŠµë°˜</p>
                    </div>
                </a>
            </div>

            <!-- Stats (moved below menu) -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="number" id="totalStudents">0</div>
                    <div class="label">ì „ì²´ í•™ìƒ</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="recordedStudents">0</div>
                    <div class="label">ë…¹í™” ì™„ë£Œ</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="todayRecordings">0</div>
                    <div class="label">ì˜¤ëŠ˜ ë…¹í™”</div>
                </div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰..." oninput="filterStudents()">
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all" onclick="setFilter('all')">ì „ì²´</button>
                <button class="filter-tab" data-filter="recorded" onclick="setFilter('recorded')">ë…¹í™” ìˆìŒ</button>
                <button class="filter-tab" data-filter="not-recorded" onclick="setFilter('not-recorded')">ë…¹í™” ì—†ìŒ</button>
            </div>

            <!-- Student List -->
            <div class="student-list" id="studentList">
                <div class="empty-state">
                    <i class="ti ti-loader" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                    <p>í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/supabase.js"></script>
    <script>
        let allStudents = [];
        let studentRecordings = {};
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                console.log('ğŸ“Š Loading dashboard data...');

                const client = await getSupabase();
                console.log('ğŸ“Š Supabase client:', client ? 'OK' : 'FAILED');

                if (!client) {
                    document.getElementById('studentList').innerHTML = `
                        <div class="empty-state">
                            <p>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨</p>
                        </div>
                    `;
                    return;
                }

                // Get all students
                const { data: students, error } = await client
                    .from('students')
                    .select('*')
                    .order('name', { ascending: true });

                console.log('ğŸ“Š Students query result:', { students, error });

                if (error) {
                    console.error('ğŸ“Š Students query error:', error);
                    throw error;
                }

                allStudents = students || [];
                console.log('ğŸ“Š Total students:', allStudents.length);

                // Get recordings for each student
                for (const student of allStudents) {
                    const { data: files, error: filesError } = await client
                        .storage
                        .from('recordings')
                        .list(student.id, { limit: 100 });

                    console.log(`ğŸ“Š Recordings for ${student.name}:`, files?.length || 0);

                    const recordings = (files || []).filter(f => f.name.endsWith('.webm'));
                    studentRecordings[student.id] = recordings;
                }

                updateStats();
                renderStudents();

            } catch (e) {
                console.error('ğŸ“Š Dashboard load error:', e);
                document.getElementById('studentList').innerHTML = `
                    <div class="empty-state">
                        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
                        <p style="font-size: 0.8rem; color: var(--text-light);">${e.message || e}</p>
                    </div>
                `;
            }
        }

        function updateStats() {
            const total = allStudents.length;
            const recorded = allStudents.filter(s => (studentRecordings[s.id] || []).length > 0).length;

            // Count today's recordings
            const today = new Date().toDateString();
            let todayCount = 0;
            for (const studentId in studentRecordings) {
                for (const rec of studentRecordings[studentId]) {
                    if (rec.created_at && new Date(rec.created_at).toDateString() === today) {
                        todayCount++;
                    }
                }
            }

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('recordedStudents').textContent = recorded;
            document.getElementById('todayRecordings').textContent = todayCount;
        }

        function renderStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('studentList');

            let filtered = allStudents.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm);
                const hasRecording = (studentRecordings[s.id] || []).length > 0;

                if (currentFilter === 'recorded' && !hasRecording) return false;
                if (currentFilter === 'not-recorded' && hasRecording) return false;

                return matchesSearch;
            });

            if (filtered.length === 0) {
                const isEmptyDatabase = allStudents.length === 0;
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="ti ti-users-group" style="font-size: 3rem; color: var(--text-light);"></i>
                        <p>${isEmptyDatabase ? 'ì•„ì§ ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤' : 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'}</p>
                        ${isEmptyDatabase ? '<p style="font-size: 0.85rem; color: var(--text-gray);">í•™ìƒì´ ì•±ì— ë¡œê·¸ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</p>' : ''}
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(student => {
                const recordings = studentRecordings[student.id] || [];
                const hasRecording = recordings.length > 0;
                const lastRecording = recordings.sort((a, b) =>
                    new Date(b.created_at || 0) - new Date(a.created_at || 0)
                )[0];

                const lastDate = lastRecording?.created_at
                    ? new Date(lastRecording.created_at).toLocaleDateString('ko-KR', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    })
                    : '-';

                const initial = student.name.charAt(0);

                return `
                    <div class="student-card" onclick="viewStudentRecordings('${student.id}', '${student.name}')">
                        <div class="student-avatar">${initial}</div>
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-meta">${student.grade || ''} Â· ë…¹í™” ${recordings.length}ê°œ</div>
                        </div>
                        <div class="student-status">
                            <span class="recording-badge ${hasRecording ? 'has-recording' : 'no-recording'}">
                                <i class="ti ti-${hasRecording ? 'video' : 'video-off'}"></i>
                                ${hasRecording ? 'ë…¹í™” ìˆìŒ' : 'ë…¹í™” ì—†ìŒ'}
                            </span>
                            <span class="last-activity">${lastDate}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterStudents() {
            renderStudents();
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.filter === filter);
            });
            renderStudents();
        }

        function viewStudentRecordings(studentId, studentName) {
            sessionStorage.setItem('viewingStudentId', studentId);
            sessionStorage.setItem('viewingStudentName', studentName);
            window.location.href = 'student-recordings.html';
        }

        function refreshData() {
            document.getElementById('studentList').innerHTML = `
                <div class="empty-state">
                    <i class="ti ti-loader" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                    <p>ìƒˆë¡œê³ ì¹¨ ì¤‘...</p>
                </div>
            `;
            loadDashboardData();
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>

</html>