<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì¬ ê´€ë¦¬ - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€í•˜ë©´ì„œ ë“œë˜ê·¸ì•¤ë“œë¡­ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.2s;
            cursor: pointer;
            background: var(--bg-white);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary);
            background: var(--primary-pale);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        /* Folder Area */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .folder-card {
            background: white;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .folder-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .folder-card.drag-over {
            border-color: var(--primary);
            background: var(--primary-pale);
            transform: scale(1.02);
        }

        .folder-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-pale);
            color: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .folder-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .folder-meta {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .add-folder-card {
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            background: transparent;
            min-height: 140px;
        }

        .add-folder-card:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-pale);
        }

        /* Textbook List (Draggable) */
        .textbook-list-container {
            background: var(--bg-light);
            border-radius: 20px;
            padding: 24px;
            min-height: 200px;
        }

        .textbook-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            cursor: grab;
            transition: all 0.2s;
        }

        .textbook-item:active {
            cursor: grabbing;
        }

        .textbook-item.dragging {
            opacity: 0.5;
            background: var(--bg-gray);
            border: 2px dashed var(--text-gray);
        }

        .textbook-item:hover {
            transform: translateX(4px);
        }

        .textbook-item-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .textbook-item-info {
            flex: 1;
        }

        .textbook-item-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .textbook-item-meta {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        /* Folder Detail Modal */
        .modal-body-scroll {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-gray);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
    </style>
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
    <link rel="apple-touch-icon" href="../favicon.png">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <a href="dashboard.html" class="back-btn"><i class="ti ti-arrow-left"></i></a>
            <h1 class="header-title">êµì¬ ê´€ë¦¬</h1>
            <div style="width: 40px;"></div>
        </header>

        <div class="content-area" style="padding-bottom: 40px;">
            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
                <div class="upload-icon">
                    <i class="ti ti-file-upload"></i>
                </div>
                <h3>Excel íŒŒì¼ ì—…ë¡œë“œ</h3>
                <p style="color: var(--text-gray); margin-top: 8px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                <p class="upload-text" style="font-size: 0.8rem; color: var(--text-light); margin-top: 4px;">
                    í˜•ì‹: Unit | ì˜ì–´ ë¬¸ì¥ | í•œêµ­ì–´ ë¬¸ì¥
                </p>
            </div>

            <div id="loadingState" style="text-align: center; padding: 40px; display: none;">
                <i class="ti ti-loader" style="font-size: 2rem; animation: spin 1s linear infinite;"></i>
                <p style="color: var(--text-gray); margin-top: 10px;">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
            </div>

            <!-- Folders Section -->
            <div class="section-header">
                <h3 style="margin: 0;">ğŸ“ í´ë”</h3>
            </div>

            <div class="folder-grid" id="folderGrid">
                <!-- Folders and Add Button will be rendered here -->
            </div>

            <!-- Uncategorized Textbooks Section -->
            <div class="section-header">
                <h3 style="margin: 0;">ğŸ“„ êµì¬ ëª©ë¡</h3>
                <p style="font-size: 0.9rem; color: var(--text-gray); margin: 0;">
                    í´ë”ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì •ë¦¬í•˜ì„¸ìš”
                </p>
            </div>

            <div class="textbook-list-container" id="uncategorizedList" ondragover="allowDrop(event)"
                ondrop="dropToUncategorized(event)">
                <!-- Uncategorized items will be rendered here -->
                <div style="text-align: center; padding: 20px; color: var(--text-gray);">
                    <i class="ti ti-loader" style="animation: spin 1s infinite linear;"></i> ë¡œë”© ì¤‘...
                </div>
            </div>
        </div>
    </div>

    <!-- Folder Detail Modal -->
    <div class="modal" id="folderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="folderModalTitle">í´ë” ë‚´ìš©</h3>
                <button class="close-btn" onclick="closeFolderModal()">&times;</button>
            </div>
            <div class="modal-body-scroll" id="folderModalBody">
                <!-- Textbooks in this folder -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-outline btn-sm" onclick="renameFolderFromModal()">í´ë” ì´ë¦„ ë³€ê²½</button>
                <button class="btn btn-outline btn-sm" style="color: #e03131; border-color: #e03131;"
                    onclick="deleteFolderFromModal()">í´ë” ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <!-- Add Folder Modal -->
    <div class="modal" id="addFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ìƒˆ í´ë” ë§Œë“¤ê¸°</h3>
                <button class="close-btn" onclick="closeAddFolderModal()">&times;</button>
            </div>
            <input type="text" id="newFolderName" class="form-input" placeholder="í´ë” ì´ë¦„ (ì˜ˆ: ì´ˆë“±, ì¤‘ë“±)"
                style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px;">
            <button class="btn btn-primary btn-block" onclick="createNewFolder()"
                style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px;">ìƒì„±</button>
        </div>
    </div>

    <script src="../js/supabase.js"></script>
    <script>
        let allTextbooks = [];
        let folders = new Set();
        let currentOpenFolder = null; // Currently open folder name in modal
        let parsedData = null; // Excel data

        document.addEventListener('DOMContentLoaded', () => {
            loadTextbooks();
            setupFileUpload();
        });

        async function loadTextbooks() {
            try {
                const { data, error } = await getTextbooks();
                if (error) throw error;

                allTextbooks = data || [];

                // Extract unique folders
                folders = new Set();
                allTextbooks.forEach(tb => {
                    if (tb.folder && tb.folder.trim()) {
                        folders.add(tb.folder.trim());
                    }
                });

                renderUI();

            } catch (err) {
                console.error('Load error:', err);
            }
        }

        function renderUI() {
            renderFolders();
            renderUncategorizedList();
        }

        function renderFolders() {
            const grid = document.getElementById('folderGrid');
            const sortedFolders = Array.from(folders).sort((a, b) =>
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );

            let html = sortedFolders.map(folderName => {
                const count = allTextbooks.filter(t => t.folder === folderName).length;
                return `
                    <div class="folder-card" 
                         onclick="openFolder('${folderName}')"
                         ondragover="allowDrop(event)" 
                         ondrop="dropToFolder(event, '${folderName}')"
                         ondragleave="leaveDrag(event)">
                        <div class="folder-icon">
                            <i class="ti ti-folder"></i>
                        </div>
                        <div class="folder-title">${folderName}</div>
                        <div class="folder-meta">${count}ê°œ êµì¬</div>
                    </div>
                `;
            }).join('');

            // Add "New Folder" button
            html += `
                <div class="folder-card add-folder-card" onclick="openAddFolderModal()">
                    <i class="ti ti-plus" style="font-size: 32px; margin-bottom: 8px;"></i>
                    <span>ìƒˆ í´ë”</span>
                </div>
            `;

            grid.innerHTML = html;
        }

        function renderUncategorizedList() {
            const list = document.getElementById('uncategorizedList');
            const uncategorized = allTextbooks.filter(t => !t.folder || !t.folder.trim());

            if (uncategorized.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; color: var(--text-gray); padding: 20px;">
                        <i class="ti ti-check-circle" style="font-size: 32px; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p>ëª¨ë“  êµì¬ê°€ í´ë”ì— ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = uncategorized.map(tb => `
                <div class="textbook-item" draggable="true" ondragstart="drag(event, '${tb.id}')">
                    <div class="textbook-item-icon">
                        <i class="ti ti-file-text"></i>
                    </div>
                    <div class="textbook-item-info">
                        <div class="textbook-item-name">${tb.name}</div>
                        <div class="textbook-item-meta">${tb.grade || ''}</div>
                    </div>
                    <div class="textbook-item-action">
                        <i class="ti ti-grip-vertical" style="color: var(--text-light);"></i>
                    </div>
                </div>
            `).join('');
        }

        // ================= Drag & Drop Logic =================

        function allowDrop(ev) {
            ev.preventDefault();
            // Highlight drop target
            if (ev.currentTarget.classList.contains('folder-card')) {
                ev.currentTarget.classList.add('drag-over');
            }
        }

        function leaveDrag(ev) {
            if (ev.currentTarget.classList.contains('folder-card')) {
                ev.currentTarget.classList.remove('drag-over');
            }
        }

        function drag(ev, id) {
            ev.dataTransfer.setData("text/plain", id);
            ev.target.classList.add('dragging');
        }

        async function dropToFolder(ev, folderName) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');

            const id = ev.dataTransfer.getData("text");
            if (!id) return;

            // Optimistic update
            const tbIndex = allTextbooks.findIndex(t => t.id === id);
            if (tbIndex === -1) return;

            const oldFolder = allTextbooks[tbIndex].folder;
            allTextbooks[tbIndex].folder = folderName;
            renderUI(); // Re-render immediately

            // DB Update
            try {
                const client = await getSupabase();
                const { error } = await client
                    .from('textbooks')
                    .update({ folder: folderName })
                    .eq('id', id);

                if (error) throw error;
                showToast(`'${folderName}' í´ë”ë¡œ ì´ë™ë¨`, 'success');
            } catch (err) {
                console.error("Move failed:", err);
                showToast("ì´ë™ ì‹¤íŒ¨", 'error');
                // Revert
                allTextbooks[tbIndex].folder = oldFolder;
                renderUI();
            }
        }

        async function dropToUncategorized(ev) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            if (!id) return;

            // Only act if coming from a folder (dragging from list to list does nothing)
            // But we can just set folder to null to be safe
            const tbIndex = allTextbooks.findIndex(t => t.id === id);
            if (tbIndex === -1) return;

            if (!allTextbooks[tbIndex].folder) return; // Already uncategorized

            const oldFolder = allTextbooks[tbIndex].folder;
            allTextbooks[tbIndex].folder = null;
            renderUI();

            try {
                const client = await getSupabase();
                const { error } = await client
                    .from('textbooks')
                    .update({ folder: null })
                    .eq('id', id);

                if (error) throw error;
                showToast("ë¯¸ë¶„ë¥˜ë¡œ ì´ë™ë¨", 'success');
            } catch (err) {
                console.error("Move failed:", err);
                showToast("ì´ë™ ì‹¤íŒ¨", 'error');
                allTextbooks[tbIndex].folder = oldFolder;
                renderUI();
            }
        }


        // ================= Folder Management =================

        function openAddFolderModal() {
            document.getElementById('newFolderName').value = '';
            document.getElementById('addFolderModal').classList.add('show');
            document.getElementById('newFolderName').focus();
        }

        function closeAddFolderModal() {
            document.getElementById('addFolderModal').classList.remove('show');
        }

        function createNewFolder() {
            const name = document.getElementById('newFolderName').value.trim();
            if (!name) return;

            if (folders.has(name)) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë”ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            // Just add to local set for now (until a textbook is added to it)
            // Or typically we need a textbook in it to persist if we don't have a folders table.
            // Since we rely on 'folder' column in textbooks, empty folders strictly speaking don't exist in DB
            // But for UX, we can show it temporarily.
            // Workaround: We will just add it to 'folders' set and re-render. 
            // It will disappear on refresh if empty, which is a known limitation of this schema.
            // To fix this proper, we'd need a 'folders' table.
            // For now, let's warn user or just let it be ephemeral.

            folders.add(name);
            renderUI();
            closeAddFolderModal();
            showToast('í´ë” ìƒì„±ë¨ (êµì¬ë¥¼ ë„£ì–´ì•¼ ì €ì¥ë©ë‹ˆë‹¤)', 'success');
        }

        function openFolder(folderName) {
            currentOpenFolder = folderName;
            document.getElementById('folderModalTitle').textContent = folderName;

            const modalBody = document.getElementById('folderModalBody');
            const folderTextbooks = allTextbooks.filter(t => t.folder === folderName);

            modalBody.innerHTML = folderTextbooks.map(tb => `
                <div class="textbook-item">
                    <div class="textbook-item-icon">
                        <i class="ti ti-file-text"></i>
                    </div>
                    <div class="textbook-item-info">
                        <div class="textbook-item-name">${tb.name}</div>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="removeFromFolder('${tb.id}')">êº¼ë‚´ê¸°</button>
                    <button class="btn btn-sm" style="color:#e03131; border:none; background:none;" onclick="deleteTextbook('${tb.id}')"><i class="ti ti-trash"></i></button>
                </div>
            `).join('');

            if (folderTextbooks.length === 0) {
                modalBody.innerHTML = '<p class="text-center text-gray">í´ë”ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.</p>';
            }

            document.getElementById('folderModal').classList.add('show');
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('show');
            currentOpenFolder = null;
        }

        async function removeFromFolder(id) {
            // Optimistic
            const tbIndex = allTextbooks.findIndex(t => t.id === id);
            if (tbIndex === -1) return;

            const oldFolder = allTextbooks[tbIndex].folder;
            allTextbooks[tbIndex].folder = null;

            // Re-render modal content
            openFolder(currentOpenFolder); // Refresh current modal
            renderFolders(); // Refresh background
            renderUncategorizedList();

            try {
                const client = await getSupabase();
                const { error } = await client
                    .from('textbooks')
                    .update({ folder: null })
                    .eq('id', id);
                if (error) throw error;
            } catch (err) {
                showToast('ì˜¤ë¥˜ ë°œìƒ', 'error');
                allTextbooks[tbIndex].folder = oldFolder;
                renderUI();
            }
        }

        async function deleteTextbook(id) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const client = await getSupabase();
                const { error } = await client.from('textbooks').delete().eq('id', id);

                if (error) throw error;

                // Local update
                allTextbooks = allTextbooks.filter(t => t.id !== id);

                if (currentOpenFolder) {
                    openFolder(currentOpenFolder);
                }
                renderUI();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (err) {
                showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        }



        async function renameFolderFromModal() {
            if (!currentOpenFolder) return;

            const newName = prompt('ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentOpenFolder);
            if (!newName || newName.trim() === '' || newName === currentOpenFolder) return;

            const oldName = currentOpenFolder;
            const cleanNewName = newName.trim();

            if (folders.has(cleanNewName)) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë” ì´ë¦„ì…ë‹ˆë‹¤', 'error');
                return;
            }

            // Optimistic Update
            folders.delete(oldName);
            folders.add(cleanNewName);

            allTextbooks.forEach(tb => {
                if (tb.folder === oldName) {
                    tb.folder = cleanNewName;
                }
            });

            document.getElementById('folderModalTitle').textContent = cleanNewName;
            currentOpenFolder = cleanNewName;
            renderUI();

            try {
                const client = await getSupabase();
                const { error } = await client
                    .from('textbooks')
                    .update({ folder: cleanNewName })
                    .eq('folder', oldName);

                if (error) throw error;
                showToast('í´ë” ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (err) {
                console.error(err);
                showToast('ë³€ê²½ ì‹¤íŒ¨', 'error');
                loadTextbooks();
            }
        }

        async function deleteFolderFromModal() {
            if (!currentOpenFolder) return;
            if (!confirm(`'${currentOpenFolder}' í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nêµì¬ëŠ” ì‚­ì œë˜ì§€ ì•Šê³  ë¯¸ë¶„ë¥˜ë¡œ ì´ë™ë©ë‹ˆë‹¤.`)) return;

            const folderName = currentOpenFolder;

            // Optimistic Update
            folders.delete(folderName);
            allTextbooks.forEach(tb => {
                if (tb.folder === folderName) {
                    tb.folder = null;
                }
            });

            closeFolderModal();
            renderUI();

            try {
                const client = await getSupabase();
                // Set folder = null for all textbooks in this folder
                const { error } = await client
                    .from('textbooks')
                    .update({ folder: null })
                    .eq('folder', folderName);

                if (error) throw error;
                showToast('í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (err) {
                console.error(err);
                showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
                loadTextbooks();
            }
        }

        // Excel Upload Logic (Existing logic reused)
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) processFile(e.target.files[0]);
            });
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    parsedData = {
                        name: file.name.replace(/\.[^/.]+$/, ''),
                        units: {}
                        // ... (Parsing logic same as before, simplified for brevity)
                    };

                    // Full parsing logic copy needed? Yes, to function.
                    // Copying the parsing logic from previous version...
                    workbook.SheetNames.forEach((sheetName) => {
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        parsedData.units[sheetName] = [];
                        for (let i = 1; i < data.length; i++) {
                            const row = data[i];
                            if (row.length >= 1 && row[0]) {
                                const en = row[0]?.toString().trim() || '';
                                const kr = row[1]?.toString().trim() || '';
                                if (en) parsedData.units[sheetName].push({ en, kr });
                            }
                        }
                    });

                    uploadData(); // Upload immediately for smoother UX? Or confirm?
                    // To keep it simple as drag-drop requested:
                    // Let's auto-upload to "Uncategorized"
                } catch (err) {
                    console.error(err);
                    showToast('íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨', 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        async function uploadData() {
            if (!parsedData) return;
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('uploadArea').style.display = 'none';

            try {
                const result = await importTextbookData(parsedData);
                if (result.error) throw new Error(result.error);

                await loadTextbooks();
                showToast('ì—…ë¡œë“œ ì™„ë£Œ! ì•„ë˜ ëª©ë¡ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'success');
            } catch (err) {
                showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('uploadArea').style.display = 'block';
                parsedData = null;
            }
        }

        // Helper: Toast
        function showToast(msg, type = 'success') {
            // Check if toast container exists
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'error' ? '#fa5252' : '#20c997'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                margin-top: 10px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                animation: slideIn 0.3s forwards;
            `;
            toast.textContent = msg;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>

</html>