<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ìƒ ë¦¬ë·° - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
    <link rel="apple-touch-icon" href="../favicon.png">
</head>

<body>
    <div class="page-container">
        <div class="content-wrapper" style="max-width: 800px;">
            <header class="page-header">
                <a href="dashboard.html" class="back-btn">â† ëŒ€ì‹œë³´ë“œë¡œ</a>
            </header>

            <div class="card">
                <div class="sentence-display" style="margin-bottom: 24px;">
                    <div class="sentence-kr" id="sentenceKr">í•œêµ­ì–´ ë¬¸ì¥</div>
                    <div class="sentence-en" id="sentenceEn">English sentence</div>
                </div>

                <div class="video-preview-container">
                    <video id="recordingVideo" class="video-preview" controls style="width: 100%;">
                        <source src="" type="video/webm">
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>
                </div>

                <div class="student-info-card"
                    style="background: var(--bg-card); padding: 16px; border-radius: var(--radius-md); margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">í•™ìƒ</span>
                        <span id="studentName">ê¹€ì² ìˆ˜</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span style="color: var(--text-secondary);">í•™ë…„</span>
                        <span id="studentGrade">ì´ˆë“± 3í•™ë…„</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">í”¼ë“œë°±</label>
                    <textarea id="feedback" class="form-input" rows="4" placeholder="í•™ìƒì—ê²Œ í”¼ë“œë°±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ìŠ¤í‹°ì»¤ ë¶€ì—¬</label>
                    <div class="sticker-selector" style="display: flex; gap: 16px; margin-top: 8px;">
                        <button class="sticker-btn" onclick="selectSticker(1)" data-count="1">â­</button>
                        <button class="sticker-btn" onclick="selectSticker(2)" data-count="2">â­â­</button>
                        <button class="sticker-btn" onclick="selectSticker(3)" data-count="3">â­â­â­</button>
                    </div>
                </div>

                <div class="video-actions" style="display: flex; gap: 16px; margin-top: 24px;">
                    <button class="btn btn-secondary" onclick="downloadVideo()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-success btn-block" onclick="submitReview()">âœ“ ë¦¬ë·° ì™„ë£Œ</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .sticker-btn {
            padding: 12px 20px;
            font-size: 1.5rem;
            background: var(--bg-card);
            border: var(--border-glass);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .sticker-btn:hover,
        .sticker-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.1);
        }
    </style>

    <script src="../js/supabase.js"></script>
    <script>
        let recordingId = null;
        let selectedStickers = 1;

        document.addEventListener('DOMContentLoaded', async () => {
            recordingId = sessionStorage.getItem('reviewRecordingId');

            if (!recordingId) {
                window.location.href = 'dashboard.html';
                return;
            }

            // Demo data
            document.getElementById('sentenceKr').textContent = 'ë‚˜ëŠ” í•™êµì— ê°‘ë‹ˆë‹¤.';
            document.getElementById('sentenceEn').textContent = 'I go to school.';
            document.getElementById('studentName').textContent = 'ê¹€ì² ìˆ˜';
            document.getElementById('studentGrade').textContent = 'ì´ˆë“± 3í•™ë…„';

            selectSticker(1);
        });

        function selectSticker(count) {
            selectedStickers = count;
            document.querySelectorAll('.sticker-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.count) === count);
            });
        }

        async function submitReview() {
            const feedback = document.getElementById('feedback').value.trim();

            showLoading('ì €ì¥ ì¤‘...');

            try {
                if (recordingId !== 'demo') {
                    await updateRecordingFeedback(recordingId, feedback, selectedStickers);
                }

                hideLoading();
                showToast('ë¦¬ë·°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            } catch (err) {
                hideLoading();
                showToast('ë¦¬ë·°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            }
        }

        function downloadVideo() {
            showToast('ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì‹¤ì œ ì˜ìƒì´ ìˆì„ ë•Œ ì‘ë™í•©ë‹ˆë‹¤', 'warning');
        }
    </script>
</body>

</html>