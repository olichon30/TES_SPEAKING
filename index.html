<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TES Speaking - ë¡œê·¸ì¸</title>
    <meta name="description" content="ì˜ì–´ ìŠ¤í”¼í‚¹ ì—°ìŠµ ì•±">
    <meta name="theme-color" content="#2D9596">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .login-container {
            text-align: center;
        }

        .login-form {
            margin-top: 32px;
        }

        .form-group {
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="login-logo">ğŸ¤</div>
        <h1 class="login-title">TES Speaking</h1>
        <p class="login-subtitle">ì˜ì–´ ìŠ¤í”¼í‚¹ ì—°ìŠµì„ ì‹œì‘í•˜ì„¸ìš”</p>

        <form id="loginForm" class="login-form">
            <div class="form-group">
                <label class="form-label">ì´ë¦„</label>
                <input type="text" id="studentName" class="form-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>

            <button type="submit" class="btn btn-primary btn-large btn-block" style="margin-top: 24px;">
                ì‹œì‘í•˜ê¸°
            </button>
        </form>

        <p style="margin-top: 24px; text-align: center;">
            <a href="teacher/login.html" style="color: var(--text-gray); font-size: 0.875rem;">
                ì„ ìƒë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ â†’
            </a>
        </p>

        <p style="text-align: center; color: var(--text-light); font-size: 0.75rem; margin-top: 40px;">
            v1.2.0
        </p>
    </div>

    <!-- Profile Confirmation Modal -->
    <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
         background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div
            style="background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 360px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 12px;">ğŸ‘‹</div>
            <h3 style="margin-bottom: 8px;" id="confirmTitle">ê¹€ë¯¼ìˆ˜ë‹˜,</h3>
            <p style="color: var(--text-gray); margin-bottom: 8px; font-size: 0.9rem;" id="confirmGrade">í•˜ê³„ì´ˆë“±</p>
            <p style="margin-bottom: 20px;">ì´ í”„ë¡œí•„ë¡œ ë¡œê·¸ì¸í• ê¹Œìš”?</p>

            <button onclick="confirmLogin()" style="width: 100%; padding: 14px; margin-bottom: 10px;
                    background: var(--primary); color: white; border: none; border-radius: 12px; 
                    cursor: pointer; font-size: 1rem; font-weight: 600;">
                ë„¤, ë¡œê·¸ì¸í•˜ê¸°
            </button>
            <button onclick="createNewProfile()" style="width: 100%; padding: 14px;
                    background: var(--bg-gray); border: none; border-radius: 12px; 
                    cursor: pointer; font-size: 0.9rem; color: var(--text-gray);">
                ì•„ë‹ˆìš”, ë™ëª…ì´ì¸ì…ë‹ˆë‹¤ (ìƒˆ í”„ë¡œí•„)
            </button>
        </div>
    </div>

    <script src="js/supabase.js"></script>
    <script>
        let pendingName = '';
        let foundStudent = null;

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('studentName').value.trim();

            if (!name) {
                showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            showLoading('í™•ì¸ ì¤‘...');
            pendingName = name;

            try {
                // Find first matching student
                const { data: student, error } = await findStudent(name);
                console.log('ğŸ” Find student:', { student, error });

                hideLoading();

                if (student) {
                    // Found existing student - show confirmation
                    foundStudent = student;
                    showConfirmModal(student);
                } else {
                    // No match - create new student directly
                    await createNewProfile();
                }

            } catch (err) {
                console.error('âŒ Login error:', err);
                hideLoading();
                showToast('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'error');
            }
        });

        function showConfirmModal(student) {
            document.getElementById('confirmTitle').textContent = student.name + 'ë‹˜,';
            document.getElementById('confirmGrade').textContent = student.grade || 'í•™ë…„ ë¯¸ì„¤ì •';
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function hideConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function confirmLogin() {
            hideConfirmModal();
            loginAsStudent(foundStudent, true);
        }

        async function createNewProfile() {
            hideConfirmModal();
            showLoading('ìƒˆ í”„ë¡œí•„ ìƒì„± ì¤‘...');

            try {
                const savedLevel = localStorage.getItem('studentLevel_' + pendingName) || null;
                const { data: student, error } = await createStudent(pendingName, savedLevel);

                if (error || !student) {
                    throw new Error(error || 'Failed to create student');
                }

                hideLoading();
                loginAsStudent(student, false);
            } catch (err) {
                console.error('Create student error:', err);
                hideLoading();
                // Fallback to local
                const student = { id: Date.now().toString(), name: pendingName, grade: null };
                loginAsStudent(student, false);
            }
        }

        function loginAsStudent(student, isExisting) {
            console.log('âœ… Login as:', student, 'isExisting:', isExisting);
            sessionStorage.setItem('currentStudent', JSON.stringify(student));

            const localOnboarding = localStorage.getItem('onboardingComplete_' + student.name);

            if (isExisting || localOnboarding) {
                localStorage.setItem('onboardingComplete_' + student.name, 'true');
                window.location.href = 'pages/main.html';
            } else {
                window.location.href = 'pages/onboarding.html';
            }
        }
    </script>
</body>

</html>