<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>4단계: 스피킹 녹화 - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
    <link rel="apple-touch-icon" href="../favicon.png">
</head>

<body>
    <div class="app-container" style="padding-bottom: 120px;">
        <!-- Header -->
        <header class="app-header">
            <a href="learn-step3.html" class="back-btn">←</a>
            <h1 class="header-title">스피킹 녹화</h1>
            <div class="header-action"></div>
        </header>

        <!-- Progress -->
        <div style="padding: 0 20px;">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%;"></div>
            </div>
            <div class="step-indicator">
                <span class="current">4단계</span> / 4단계 (마지막!)
            </div>
        </div>

        <div class="page-content">
            <!-- Step Header -->
            <div class="step-header">
                <span class="step-badge"><i class="ti ti-video"></i> 스피킹 녹화</span>
                <h2 class="step-title">모든 문장을 읽고 녹화하세요</h2>
            </div>

            <!-- Video Preview (hidden initially) -->
            <div class="hidden" id="previewSection">
                <video id="videoPreview" style="width: 100%; border-radius: var(--radius-lg); background: #000;"
                    controls></video>
            </div>

            <!-- Camera Preview -->
            <div id="cameraSection">
                <video id="cameraPreview"
                    style="width: 100%; border-radius: var(--radius-lg); background: #000; transform: scaleX(-1);"
                    autoplay muted playsinline></video>
            </div>

            <!-- Recording Timer -->
            <div class="text-center mt-2">
                <span id="recordingTimer" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-coral);"
                    class="hidden">00:00</span>
            </div>

            <!-- Sentences Reference -->
            <div class="card mt-2">
                <!-- Toggle options for display -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                    <p class="text-gray" style="font-size: 0.875rem; margin: 0;">읽을 문장들:</p>
                    <div style="display: flex; gap: 12px;">
                        <label
                            style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: var(--text-gray); cursor: pointer;">
                            <input type="checkbox" id="showKorean" onchange="renderSentences()"
                                style="width: 16px; height: 16px; accent-color: var(--primary);">
                            <span>한글</span>
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 4px; font-size: 0.8rem; color: var(--text-gray); cursor: pointer;">
                            <input type="checkbox" id="showEnglish" onchange="renderSentences()" checked
                                style="width: 16px; height: 16px; accent-color: var(--primary);">
                            <span>영어</span>
                        </label>
                    </div>
                </div>
                <div id="sentenceList" style="font-size: 0.9rem; max-height: 180px; overflow-y: auto;"></div>
            </div>

            <!-- Recording Controls -->
            <div class="recording-controls" id="recordControls">
                <button class="record-btn-large" id="recordBtn" onclick="toggleRecording()"><i class="ti ti-video"
                        style="font-size: 2rem;"></i></button>
            </div>
            <p class="text-center text-gray" id="recordHint">버튼을 눌러 녹화 시작</p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons hidden" id="actionButtons">
            <button class="btn btn-secondary" onclick="retryRecording()">다시 녹화</button>
            <button class="btn btn-secondary" onclick="saveRecording()">녹화 저장</button>
            <button class="btn btn-primary" onclick="completeLesson()">완료 →</button>
        </div>
    </div>

    <script src="../js/supabase.js"></script>
    <script src="../js/recorder.js"></script>
    <script>
        let sentences = [];
        let isRecording = false;
        let recordedBlob = null;
        let cameraStream = null;
        let timerInterval = null;
        let recordingSeconds = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            sentences = JSON.parse(sessionStorage.getItem('currentSentences')) || [];
            if (sentences.length === 0) {
                window.location.href = 'learn-step1.html';
                return;
            }

            renderSentences();
            await initCamera();
        });

        function renderSentences() {
            const list = document.getElementById('sentenceList');
            const showKorean = document.getElementById('showKorean').checked;
            const showEnglish = document.getElementById('showEnglish').checked;

            // If neither is checked, show at least English
            const displayEnglish = showEnglish || (!showKorean && !showEnglish);
            const displayKorean = showKorean;

            list.innerHTML = sentences.map((s, i) => `
                <div style="padding: 8px 0; border-bottom: 1px solid var(--bg-gray);">
                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                        <span style="color: var(--primary); font-weight: 600; min-width: 24px;">${i + 1}.</span>
                        <div>
                            ${displayEnglish ? `<div style="font-weight: 500;">${s.en}</div>` : ''}
                            ${displayKorean ? `<div style="color: var(--text-gray); font-size: 0.85rem;${displayEnglish ? ' margin-top: 4px;' : ''}">${s.kr}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function initCamera() {
            try {
                // Stop any existing stream first
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }

                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: true
                });
                document.getElementById('cameraPreview').srcObject = cameraStream;
            } catch (e) {
                console.error('Camera error:', e);
                showToast('카메라 접근을 허용해주세요', 'error');
            }
        }

        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const hint = document.getElementById('recordHint');
            const timer = document.getElementById('recordingTimer');

            if (!isRecording) {
                // Start recording
                try {
                    // Ensure camera is ready
                    if (!cameraStream) {
                        await initCamera();
                    }

                    await recorder.startCameraRecording((time) => {
                        timer.textContent = time;
                    });

                    isRecording = true;
                    btn.classList.add('recording');
                    btn.innerHTML = '<i class="ti ti-player-stop" style="font-size: 2rem;"></i>';
                    timer.classList.remove('hidden');
                    hint.textContent = '녹화 중... 버튼을 눌러 중지';
                } catch (e) {
                    console.error('Recording error:', e);
                    showToast('녹화를 시작할 수 없습니다', 'error');
                }
            } else {
                // Stop recording
                recordedBlob = await recorder.stopRecording();
                isRecording = false;
                btn.classList.remove('recording');
                btn.innerHTML = '<i class="ti ti-video" style="font-size: 2rem;"></i>';
                timer.classList.add('hidden');
                hint.textContent = '녹화 완료!';

                if (recordedBlob) {
                    // Stop camera to free resources
                    if (cameraStream) {
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraStream = null;
                    }

                    // Show preview
                    const url = URL.createObjectURL(recordedBlob);
                    document.getElementById('videoPreview').src = url;
                    document.getElementById('previewSection').classList.remove('hidden');
                    document.getElementById('cameraSection').classList.add('hidden');

                    // Show action buttons
                    document.getElementById('actionButtons').classList.remove('hidden');
                }
            }
        }

        async function retryRecording() {
            recordedBlob = null;
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('cameraSection').classList.remove('hidden');
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('recordHint').textContent = '버튼을 눌러 녹화 시작';
            document.getElementById('recordBtn').innerHTML = '<i class="ti ti-video" style="font-size: 2rem;"></i>';

            await initCamera();
        }

        async function saveRecording() {
            if (!recordedBlob) return;

            showLoading('Supabase에 저장 중...');

            try {
                const student = JSON.parse(sessionStorage.getItem('currentStudent'));
                const studentId = student?.id || 'demo';
                const studentName = student?.name || 'student';

                // Get unit info from sessionStorage
                const unitTitle = sessionStorage.getItem('currentUnitTitle') || 'Unit';

                const { data: videoUrl, error } = await uploadVideo(recordedBlob, studentId, studentName, unitTitle);

                if (error) {
                    hideLoading();
                    showToast('저장 실패: ' + error.message, 'error');
                    return;
                }

                if (videoUrl) {
                    sessionStorage.setItem('recordingUrl', videoUrl);
                    hideLoading();
                    showToast('녹화가 클라우드에 저장되었습니다\n(Supabase Storage)', 'success');
                } else {
                    hideLoading();
                    showToast('녹화가 저장되었습니다', 'success');
                }
            } catch (e) {
                console.error('Upload error:', e);
                hideLoading();
                showToast('저장 중 오류가 발생했습니다', 'error');
            }
        }

        function completeLesson() {
            // Stop camera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            window.location.href = 'complete.html';
        }

        // Cleanup on page leave
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>

</html>