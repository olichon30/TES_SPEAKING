<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3ë‹¨ê³„: í•œâ†’ì˜ ë§í•˜ê¸° - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
</head>

<body>
    <div class="app-container" style="padding-bottom: 120px;">
        <!-- Header -->
        <header class="app-header">
            <a href="learn-step2.html" class="back-btn">â†</a>
            <h1 class="header-title">í•œâ†’ì˜ ë§í•˜ê¸°</h1>
            <div class="header-action"></div>
        </header>

        <!-- Progress -->
        <div style="padding: 0 20px;">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 75%;"></div>
            </div>
            <div class="step-indicator">
                <span class="current">3ë‹¨ê³„</span> / 4ë‹¨ê³„
            </div>
        </div>

        <div class="page-content">
            <!-- Step Header -->
            <div class="step-header">
                <span class="step-badge"><i class="ti ti-message-circle"></i> í•œâ†’ì˜ ë§í•˜ê¸°</span>
                <h2 class="step-title">í•œêµ­ì–´ë¥¼ ì˜ì–´ë¡œ ë§í•´ë³´ì„¸ìš”</h2>
            </div>

            <!-- Korean Sentence Card (English hidden) -->
            <div class="sentence-card">
                <div class="sentence-kr" id="sentenceKr"
                    style="font-size: 1.5rem; font-weight: 600; color: var(--text-dark);">
                    ì•ˆë…•í•˜ì„¸ìš”
                </div>
                <p class="text-center text-gray mt-2" style="font-size: 0.9rem;">
                    ğŸ¤ ìœ„ ë¬¸ì¥ì„ ì˜ì–´ë¡œ ë§í•´ë³´ì„¸ìš”
                </p>
            </div>

            <!-- Comparison Result (shown after speaking) -->
            <div id="comparisonResult" class="hidden" style="margin: 16px 0; padding: 16px; 
                 background: var(--bg-white); border-radius: var(--radius-md); text-align: left;"></div>

            <!-- Main Record Button -->
            <button class="record-btn-large" id="recordBtn" onclick="toggleRecording()">
                <i class="ti ti-microphone" style="font-size: 2rem;"></i>
            </button>
            <p class="text-center text-gray" id="recordHint">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜ì–´ë¡œ ë§í•˜ì„¸ìš”</p>

            <!-- Accuracy Display (hidden initially) -->
            <div class="accuracy-display hidden" id="accuracyDisplay">
                <div class="accuracy-circle" style="--accuracy: 0;">
                    <span class="accuracy-value" id="accuracyValue">0%</span>
                </div>
                <div class="accuracy-label">ì •í™•ë„</div>
            </div>

            <!-- Small Retry Button (shown after recording) -->
            <button class="hidden" id="retryBtn" onclick="toggleRecording()" style="display: flex; align-items: center; gap: 8px; margin: 16px auto;
                       padding: 10px 20px; border-radius: 20px; background: var(--bg-gray);
                       color: var(--text-gray); font-size: 0.9rem; border: none; cursor: pointer;">
                <i class="ti ti-refresh"></i> ë‹¤ì‹œí•˜ê¸°
            </button>

            <!-- Sentence Counter -->
            <p class="text-center mt-3" style="color: var(--primary); font-weight: 600;">
                <span id="currentIndex">1</span> / <span id="totalCount">5</span> ë¬¸ì¥
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="prevSentence()">ì´ì „</button>
            <button class="btn btn-primary" onclick="nextSentence()" id="nextBtn">ë‹¤ìŒ</button>
        </div>
    </div>

    <script src="../js/supabase.js"></script>
    <script src="../js/speech.js"></script>
    <script>
        let sentences = [];
        let currentIndex = 0;
        let isRecording = false;

        document.addEventListener('DOMContentLoaded', () => {
            sentences = JSON.parse(sessionStorage.getItem('currentSentences')) || [];
            if (sentences.length === 0) {
                window.location.href = 'learn-step1.html';
                return;
            }

            document.getElementById('totalCount').textContent = sentences.length;
            updateSentence();
        });

        function updateSentence() {
            const s = sentences[currentIndex];
            document.getElementById('sentenceKr').textContent = s.kr;
            document.getElementById('currentIndex').textContent = currentIndex + 1;

            // Reset UI state
            document.getElementById('accuracyDisplay').classList.add('hidden');
            document.getElementById('comparisonResult').classList.add('hidden');
            document.getElementById('recordHint').textContent = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜ì–´ë¡œ ë§í•˜ì„¸ìš”';
            document.getElementById('recordHint').classList.remove('hidden');

            // Show big record button, hide retry button
            document.getElementById('recordBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.add('hidden');

            // Update next button text
            const nextBtn = document.getElementById('nextBtn');
            if (currentIndex === sentences.length - 1) {
                nextBtn.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ â†’';
            } else {
                nextBtn.textContent = 'ë‹¤ìŒ';
            }
        }

        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const retryBtn = document.getElementById('retryBtn');
            const hint = document.getElementById('recordHint');

            if (!isRecording) {
                // Start recording
                isRecording = true;

                // Show main record button (important when coming from retry button)
                btn.classList.remove('hidden');
                retryBtn.classList.add('hidden');
                hint.classList.remove('hidden');

                btn.classList.add('recording');
                btn.innerHTML = '<i class="ti ti-player-stop" style="font-size: 2rem;"></i>';
                hint.textContent = 'ë§í•˜ê³  ìˆì–´ìš”... ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¤‘ì§€';

                // Hide previous results
                document.getElementById('accuracyDisplay').classList.add('hidden');
                document.getElementById('comparisonResult').classList.add('hidden');

                // Start speech recognition
                if (typeof startSpeechRecognition === 'function') {
                    startSpeechRecognition(sentences[currentIndex].en, (result) => {
                        // Stop UI first to reset state
                        stopRecordingUI();

                        if (result.error) {
                            showError(result.errorMessage || 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        } else {
                            showAccuracy(result.accuracy, result.transcript);
                        }
                    });
                } else {
                    stopRecordingUI();
                    showError('ìŒì„±ì¸ì‹ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                // Stop recording
                if (typeof stopSpeechRecognition === 'function') {
                    stopSpeechRecognition();
                }
                stopRecordingUI();
            }
        }

        function stopRecordingUI() {
            const btn = document.getElementById('recordBtn');
            const retryBtn = document.getElementById('retryBtn');
            const hint = document.getElementById('recordHint');

            isRecording = false;
            btn.classList.remove('recording');
            btn.innerHTML = '<i class="ti ti-microphone" style="font-size: 2rem;"></i>';

            // Hide big button, show small retry button
            btn.classList.add('hidden');
            retryBtn.classList.remove('hidden');
            retryBtn.style.display = 'flex';
            hint.classList.add('hidden');
        }

        function showError(message) {
            const display = document.getElementById('accuracyDisplay');
            const hint = document.getElementById('recordHint');

            display.classList.add('hidden');
            hint.innerHTML = '<span style="color: #e53935;">' + message + '</span>';
            hint.classList.remove('hidden'); // Ensure visible
        }

        function showAccuracy(accuracy, transcript) {
            const display = document.getElementById('accuracyDisplay');
            const value = document.getElementById('accuracyValue');
            const circle = display.querySelector('.accuracy-circle');
            const comparisonDiv = document.getElementById('comparisonResult');

            display.classList.remove('hidden');
            value.textContent = accuracy + '%';
            circle.style.setProperty('--accuracy', accuracy);

            // Save accuracy to learningProgress
            const progress = JSON.parse(sessionStorage.getItem('learningProgress') || '{"accuracyScores": []}');
            progress.accuracyScores = progress.accuracyScores || [];
            progress.accuracyScores.push(accuracy);
            sessionStorage.setItem('learningProgress', JSON.stringify(progress));

            // Show comparison with highlighted differences
            if (transcript) {
                const targetText = sentences[currentIndex].en;
                const comparisonHtml = compareWords(targetText, transcript);
                comparisonDiv.innerHTML = comparisonHtml;
                comparisonDiv.classList.remove('hidden');
            }
        }

        // Compare target and spoken words, highlight differences
        function compareWords(target, spoken) {
            const targetWords = target.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const originalTargetWords = target.replace(/[^\w\s]/g, '').split(/\s+/);
            const originalSpokenWords = spoken.replace(/[^\w\s]/g, '').split(/\s+/);

            // Build target line with highlights
            let resultHtml = '<div><strong style="color: var(--text-gray);">ì •ë‹µ:</strong> ';
            for (let i = 0; i < originalTargetWords.length; i++) {
                const word = originalTargetWords[i];
                const wordLower = word.toLowerCase();

                if (spokenWords.includes(wordLower)) {
                    resultHtml += `<span style="color: #22C55E; font-weight: 600;">${word}</span> `;
                } else {
                    resultHtml += `<span style="color: #EF4444; font-weight: 600; text-decoration: underline;">${word}</span> `;
                }
            }
            resultHtml += '</div>';

            // Build spoken line with highlights (show extra words in orange)
            resultHtml += '<div style="margin-top: 8px;"><strong style="color: var(--text-gray);">ë‚´ ë°œìŒ:</strong> ';
            for (let i = 0; i < originalSpokenWords.length; i++) {
                const word = originalSpokenWords[i];
                const wordLower = word.toLowerCase();

                if (targetWords.includes(wordLower)) {
                    resultHtml += `<span style="color: #22C55E;">${word}</span> `;
                } else {
                    // Extra word not in target - show in orange with strikethrough
                    resultHtml += `<span style="color: #F59E0B; text-decoration: line-through;">${word}</span> `;
                }
            }
            resultHtml += '</div>';

            return resultHtml;
        }

        function showHint() {
            const comparisonDiv = document.getElementById('comparisonResult');
            const targetText = sentences[currentIndex].en;

            comparisonDiv.innerHTML = `<div><strong style="color: var(--text-gray);">ì •ë‹µ:</strong> <span style="color: var(--primary); font-weight: 600;">${targetText}</span></div>`;
            comparisonDiv.classList.remove('hidden');

            // Hide hint button after showing
            document.getElementById('hintBtn').classList.add('hidden');
        }

        function showError(message) {
            const display = document.getElementById('accuracyDisplay');
            const hint = document.getElementById('recordHint');

            display.classList.add('hidden');
            hint.classList.remove('hidden');
            hint.innerHTML = '<span style="color: #e53935;">' + message + '</span>';
        }

        function prevSentence() {
            if (currentIndex > 0) {
                currentIndex--;
                updateSentence();
            }
        }

        function nextSentence() {
            if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateSentence();
            } else {
                // Go to step 4
                window.location.href = 'learn-step4.html';
            }
        }
    </script>
</body>

</html>