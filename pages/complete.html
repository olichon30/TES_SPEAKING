<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>학습 완료 - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon.png">
    <link rel="apple-touch-icon" href="../favicon.png">
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <div class="app-container">
        <div class="page-content">
            <div class="complete-container">
                <!-- Success Icon -->
                <div class="complete-icon"><i class="ti ti-confetti"
                        style="font-size: 4rem; color: var(--primary);"></i></div>

                <h1 class="complete-title">학습 완료!</h1>
                <p class="complete-subtitle">오늘도 열심히 공부했어요</p>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stepCount">4</div>
                        <div class="stat-label">완료 단계</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sentenceCount">0</div>
                        <div class="stat-label">학습 문장</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracyAvg">-</div>
                        <div class="stat-label">평균 정확도</div>
                    </div>
                </div>

                <!-- Achievement Card -->
                <div class="card mt-3"
                    style="background: linear-gradient(135deg, var(--accent-yellow) 0%, #FBBF24 100%); color: var(--text-dark);">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <span><i class="ti ti-trophy" style="font-size: 3rem;"></i></span>
                        <div>
                            <div style="font-weight: 700; font-size: 1.125rem;">오늘의 학습 완료!</div>
                            <div style="font-size: 0.875rem; opacity: 0.8;">꾸준히 하면 영어 실력이 늘어요</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-3" style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-primary btn-block" onclick="shareRecording()">
                        <i class="ti ti-share"></i> 녹화 공유하기
                    </button>
                    <button class="btn btn-outline btn-block" onclick="viewStats()">
                        <i class="ti ti-chart-bar"></i> 학습 통계 보기
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="goHome()">
                        <i class="ti ti-home"></i> 홈으로
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="main.html" class="nav-item">
                <span class="nav-icon"><i class="ti ti-home"></i></span>
                <span>홈</span>
            </a>
            <a href="class.html" class="nav-item">
                <span class="nav-icon"><i class="ti ti-books"></i></span>
                <span>클래스</span>
            </a>
            <a href="stats.html" class="nav-item">
                <span class="nav-icon"><i class="ti ti-chart-bar"></i></span>
                <span>통계</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon"><i class="ti ti-user"></i></span>
                <span>프로필</span>
            </a>
        </nav>
    </div>

    <script src="../js/supabase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get actual learning data from sessionStorage
            const sentences = JSON.parse(sessionStorage.getItem('currentSentences')) || [];
            const learningProgress = JSON.parse(sessionStorage.getItem('learningProgress')) || {};

            // Sentence count
            document.getElementById('sentenceCount').textContent = sentences.length;

            // Steps completed (from learningProgress or default 4 if at step4 complete)
            const stepsCompleted = learningProgress.completedSteps || 4;
            document.getElementById('stepCount').textContent = stepsCompleted;

            // Average accuracy (from learningProgress or calculate)
            const accuracyScores = learningProgress.accuracyScores || [];
            if (accuracyScores.length > 0) {
                const avgAccuracy = Math.round(accuracyScores.reduce((a, b) => a + b, 0) / accuracyScores.length);
                document.getElementById('accuracyAvg').textContent = avgAccuracy + '%';
            } else {
                // No accuracy data recorded
                document.getElementById('accuracyAvg').textContent = '-';
            }

            // Save completion to localStorage for stats tracking
            const student = JSON.parse(sessionStorage.getItem('currentStudent'));
            if (student) {
                const today = new Date().toISOString().split('T')[0];
                const completionKey = `completion_${student.name}_${today}`;
                const todayData = JSON.parse(localStorage.getItem(completionKey) || '{"sentences": 0, "sessions": 0}');
                todayData.sentences += sentences.length;
                todayData.sessions += 1;
                localStorage.setItem(completionKey, JSON.stringify(todayData));

                // Save last learning info for "Continue Learning" feature
                const currentUnit = JSON.parse(sessionStorage.getItem('currentUnit') || 'null');
                const currentTextbook = JSON.parse(sessionStorage.getItem('currentTextbook') || 'null');

                const lastLearning = {
                    unitTitle: currentUnit?.title || '학습',
                    unitId: currentUnit?.id || null,
                    textbookName: currentTextbook?.name || null,
                    textbookId: currentTextbook?.id || null,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('lastLearning_' + student.name, JSON.stringify(lastLearning));
            }
        });

        function shareRecording() {
            const recordingUrl = sessionStorage.getItem('recordingUrl');

            if (navigator.share) {
                navigator.share({
                    title: 'TES Speaking 녹화',
                    text: '오늘의 스피킹 연습을 완료했어요!',
                    url: recordingUrl || window.location.href
                }).catch(err => console.log('Share failed:', err));
            } else {
                // Fallback: copy to clipboard
                if (recordingUrl) {
                    navigator.clipboard.writeText(recordingUrl);
                    showToast('링크가 복사되었습니다', 'success');
                } else {
                    showToast('공유할 녹화가 없습니다', 'warning');
                }
            }
        }

        function viewStats() {
            window.location.href = 'stats.html';
        }

        function goHome() {
            window.location.href = 'main.html';
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>

</html>