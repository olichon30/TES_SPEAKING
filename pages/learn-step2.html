<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2단계: 발음 연습 - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
</head>

<body>
    <div class="app-container" style="padding-bottom: 120px;">
        <!-- Header -->
        <header class="app-header">
            <a href="learn-step1.html" class="back-btn">←</a>
            <h1 class="header-title">발음 연습</h1>
            <div class="header-action"></div>
        </header>

        <!-- Progress -->
        <div style="padding: 0 20px;">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 50%;"></div>
            </div>
            <div class="step-indicator">
                <span class="current">2단계</span> / 4단계
            </div>
        </div>

        <div class="page-content">
            <!-- Step Header -->
            <div class="step-header">
                <span class="step-badge"><i class="ti ti-microphone"></i> 발음 연습</span>
                <h2 class="step-title">문장을 따라 읽어보세요</h2>
            </div>

            <!-- Current Sentence Card with TTS icon -->
            <div class="sentence-card" style="position: relative;">
                <!-- TTS Icon Button - top right corner -->
                <button id="ttsBtn" onclick="playTTS()" style="position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; 
                           border-radius: 50%; background: var(--primary-pale); color: var(--primary);
                           display: flex; align-items: center; justify-content: center; border: none;
                           cursor: pointer; transition: 0.2s;">
                    <i class="ti ti-volume" style="font-size: 1.2rem;"></i>
                </button>
                <div class="sentence-kr" id="sentenceKr">안녕하세요</div>
                <div class="sentence-en" id="sentenceEn">Hello</div>
            </div>

            <!-- Comparison Result (moved here - right after sentence card) -->
            <div id="comparisonResult" class="hidden" style="margin: 16px 0; padding: 16px; 
                 background: var(--bg-white); border-radius: var(--radius-md); text-align: left;"></div>

            <!-- Main Record Button (shown when not recorded yet) -->
            <button class="record-btn-large" id="recordBtn" onclick="toggleRecording()">
                <i class="ti ti-microphone" style="font-size: 2rem;"></i>
            </button>
            <p class="text-center text-gray" id="recordHint">버튼을 눌러 말하세요</p>

            <!-- Accuracy Display (hidden initially) -->
            <div class="accuracy-display hidden" id="accuracyDisplay">
                <div class="accuracy-circle" style="--accuracy: 0;">
                    <span class="accuracy-value" id="accuracyValue">0%</span>
                </div>
                <div class="accuracy-label">정확도</div>
            </div>

            <!-- Small Retry Button (shown after recording) -->
            <button class="hidden" id="retryBtn" onclick="toggleRecording()" style="display: flex; align-items: center; gap: 8px; margin: 16px auto;
                       padding: 10px 20px; border-radius: 20px; background: var(--bg-gray);
                       color: var(--text-gray); font-size: 0.9rem; border: none; cursor: pointer;">
                <i class="ti ti-refresh"></i> 다시하기
            </button>

            <!-- Sentence Counter -->
            <p class="text-center mt-2" style="color: var(--primary); font-weight: 600;">
                <span id="currentIndex">1</span> / <span id="totalCount">5</span> 문장
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="prevSentence()">이전</button>
            <button class="btn btn-primary" onclick="nextSentence()" id="nextBtn">다음</button>
        </div>
    </div>

    <script src="../js/supabase.js"></script>
    <script src="../js/tts.js"></script>
    <script src="../js/speech.js"></script>
    <script>
        let sentences = [];
        let currentIndex = 0;
        let isRecording = false;

        document.addEventListener('DOMContentLoaded', () => {
            sentences = JSON.parse(sessionStorage.getItem('currentSentences')) || [];
            if (sentences.length === 0) {
                window.location.href = 'learn-step1.html';
                return;
            }

            document.getElementById('totalCount').textContent = sentences.length;
            updateSentence();
        });

        function updateSentence() {
            const s = sentences[currentIndex];
            document.getElementById('sentenceKr').textContent = s.kr;
            document.getElementById('sentenceEn').textContent = s.en;
            document.getElementById('currentIndex').textContent = currentIndex + 1;

            // Reset UI state
            document.getElementById('accuracyDisplay').classList.add('hidden');
            document.getElementById('comparisonResult').classList.add('hidden');
            document.getElementById('recordHint').textContent = '버튼을 눌러 말하세요';
            document.getElementById('recordHint').classList.remove('hidden');

            // Show big record button, hide retry button
            document.getElementById('recordBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.add('hidden');

            // Update next button text
            const nextBtn = document.getElementById('nextBtn');
            if (currentIndex === sentences.length - 1) {
                nextBtn.textContent = '다음 단계로 →';
            } else {
                nextBtn.textContent = '다음';
            }
        }

        async function playTTS() {
            const btn = document.getElementById('ttsBtn');
            const originalBg = btn.style.background;
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';

            try {
                await tts.speak(sentences[currentIndex].en, { rate: 0.85 });
            } catch (e) {
                console.error('TTS Error:', e);
            }

            btn.style.background = originalBg || 'var(--primary-pale)';
            btn.style.color = 'var(--primary)';
        }

        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const retryBtn = document.getElementById('retryBtn');
            const hint = document.getElementById('recordHint');

            if (!isRecording) {
                // Start recording
                isRecording = true;
                btn.classList.add('recording');
                btn.innerHTML = '<i class="ti ti-player-stop" style="font-size: 2rem;"></i>';
                hint.textContent = '말하고 있어요... 버튼을 눌러 중지';

                // Hide previous results
                document.getElementById('accuracyDisplay').classList.add('hidden');
                retryBtn.classList.add('hidden');
                document.getElementById('comparisonResult').classList.add('hidden');

                // Start speech recognition
                if (typeof startSpeechRecognition === 'function') {
                    startSpeechRecognition(sentences[currentIndex].en, (result) => {
                        if (result.error) {
                            showError(result.errorMessage || '음성 인식 오류가 발생했습니다.');
                        } else {
                            showAccuracy(result.accuracy, result.transcript);
                        }
                        stopRecordingUI();
                    });
                } else {
                    showError('음성인식 모듈을 불러올 수 없습니다.');
                    stopRecordingUI();
                }
            } else {
                // Stop recording
                if (typeof stopSpeechRecognition === 'function') {
                    stopSpeechRecognition();
                }
                stopRecordingUI();
            }
        }

        function stopRecordingUI() {
            const btn = document.getElementById('recordBtn');
            const retryBtn = document.getElementById('retryBtn');
            const hint = document.getElementById('recordHint');

            isRecording = false;
            btn.classList.remove('recording');
            btn.innerHTML = '<i class="ti ti-microphone" style="font-size: 2rem;"></i>';

            // Hide big button, show small retry button
            btn.classList.add('hidden');
            retryBtn.classList.remove('hidden');
            retryBtn.style.display = 'flex';
            hint.classList.add('hidden');
        }

        function showAccuracy(accuracy, transcript) {
            const display = document.getElementById('accuracyDisplay');
            const value = document.getElementById('accuracyValue');
            const circle = display.querySelector('.accuracy-circle');
            const comparisonDiv = document.getElementById('comparisonResult');

            display.classList.remove('hidden');
            value.textContent = accuracy + '%';
            circle.style.setProperty('--accuracy', accuracy);

            // Save accuracy to learningProgress
            const progress = JSON.parse(sessionStorage.getItem('learningProgress') || '{"accuracyScores": []}');
            progress.accuracyScores = progress.accuracyScores || [];
            progress.accuracyScores.push(accuracy);
            sessionStorage.setItem('learningProgress', JSON.stringify(progress));

            // Show comparison with highlighted differences
            if (transcript) {
                const targetText = sentences[currentIndex].en;
                const comparisonHtml = compareWords(targetText, transcript);
                comparisonDiv.innerHTML = comparisonHtml;
                comparisonDiv.classList.remove('hidden');
            }
        }

        // Compare target and spoken words, highlight differences
        function compareWords(target, spoken) {
            const targetWords = target.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const originalTargetWords = target.replace(/[^\w\s]/g, '').split(/\s+/);
            const originalSpokenWords = spoken.replace(/[^\w\s]/g, '').split(/\s+/);

            // Build target line with highlights
            let resultHtml = '<div><strong style="color: var(--text-gray);">정답:</strong> ';
            for (let i = 0; i < originalTargetWords.length; i++) {
                const word = originalTargetWords[i];
                const wordLower = word.toLowerCase();

                if (spokenWords.includes(wordLower)) {
                    resultHtml += `<span style="color: #22C55E; font-weight: 600;">${word}</span> `;
                } else {
                    resultHtml += `<span style="color: #EF4444; font-weight: 600; text-decoration: underline;">${word}</span> `;
                }
            }
            resultHtml += '</div>';

            // Build spoken line with highlights (show extra words in orange)
            resultHtml += '<div style="margin-top: 8px;"><strong style="color: var(--text-gray);">내 발음:</strong> ';
            for (let i = 0; i < originalSpokenWords.length; i++) {
                const word = originalSpokenWords[i];
                const wordLower = word.toLowerCase();

                if (targetWords.includes(wordLower)) {
                    resultHtml += `<span style="color: #22C55E;">${word}</span> `;
                } else {
                    // Extra word not in target - show in orange with strikethrough
                    resultHtml += `<span style="color: #F59E0B; text-decoration: line-through;">${word}</span> `;
                }
            }
            resultHtml += '</div>';

            return resultHtml;
        }

        function showError(message) {
            const display = document.getElementById('accuracyDisplay');
            const hint = document.getElementById('recordHint');

            display.classList.add('hidden');
            hint.innerHTML = '<span style="color: #e53935;">' + message + '</span>';
        }

        function prevSentence() {
            if (currentIndex > 0) {
                currentIndex--;
                updateSentence();
            }
        }

        function nextSentence() {
            if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateSentence();
            } else {
                // Go to next step
                window.location.href = 'learn-step3.html';
            }
        }
    </script>
</body>

</html>