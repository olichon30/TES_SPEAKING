<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2ë‹¨ê³„: ë°œìŒ ì—°ìŠµ - TES Speaking</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
    </style>
</head>

<body>
    <div class="app-container" style="padding-bottom: 120px;">
        <!-- Header -->
        <header class="app-header">
            <a href="learn-step1.html" class="back-btn">â†</a>
            <h1 class="header-title">ë°œìŒ ì—°ìŠµ</h1>
            <div class="header-action"></div>
        </header>

        <!-- Progress -->
        <div style="padding: 0 20px;">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 50%;"></div>
            </div>
            <div class="step-indicator">
                <span class="current">2ë‹¨ê³„</span> / 4ë‹¨ê³„
            </div>
        </div>

        <div class="page-content">
            <!-- Step Header -->
            <div class="step-header">
                <span class="step-badge"><i class="ti ti-microphone"></i> ë°œìŒ ì—°ìŠµ</span>
                <h2 class="step-title">ë¬¸ì¥ì„ ë”°ë¼ ì½ì–´ë³´ì„¸ìš”</h2>
            </div>

            <!-- Current Sentence Card with TTS icon -->
            <div class="sentence-card" style="position: relative;">
                <!-- TTS Icon Button - top right corner -->
                <button id="ttsBtn" onclick="playTTS()" style="position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; 
                           border-radius: 50%; background: var(--primary-pale); color: var(--primary);
                           display: flex; align-items: center; justify-content: center; border: none;
                           cursor: pointer; transition: 0.2s;">
                    <i class="ti ti-volume" style="font-size: 1.2rem;"></i>
                </button>
                <div class="sentence-kr" id="sentenceKr">ì•ˆë…•í•˜ì„¸ìš”</div>
                <div class="sentence-en" id="sentenceEn">Hello</div>
            </div>

            <!-- Comparison Result (moved here - right after sentence card) -->
            <div id="comparisonResult" class="hidden" style="margin: 16px 0; padding: 16px; 
                 background: var(--bg-white); border-radius: var(--radius-md); text-align: left;"></div>

            <!-- Main Record Button (shown when not recorded yet) -->
            <button class="record-btn-large" id="recordBtn" onclick="toggleRecording()">
                <i class="ti ti-microphone" style="font-size: 2rem;"></i>
            </button>

            <!-- Audio Level Meter (shows during recording) -->
            <div id="audioLevelContainer" class="hidden"
                style="display: flex; align-items: center; justify-content: center; gap: 3px; height: 40px; margin: 12px 0;">
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
                <div class="audio-bar"
                    style="width: 6px; background: var(--primary); border-radius: 3px; transition: height 0.05s;"></div>
            </div>

            <p class="text-center text-gray" id="recordHint">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§í•˜ì„¸ìš”</p>

            <!-- Accuracy Display (hidden initially) -->
            <div class="accuracy-display hidden" id="accuracyDisplay">
                <div class="accuracy-circle" style="--accuracy: 0;">
                    <span class="accuracy-value" id="accuracyValue">0%</span>
                </div>
                <div class="accuracy-label">ì •í™•ë„</div>
            </div>

            <!-- Small Retry Button (shown after recording) -->
            <button class="hidden" id="retryBtn" onclick="toggleRecording()" style="display: flex; align-items: center; gap: 8px; margin: 16px auto;
                       padding: 10px 20px; border-radius: 20px; background: var(--bg-gray);
                       color: var(--text-gray); font-size: 0.9rem; border: none; cursor: pointer;">
                <i class="ti ti-refresh"></i> ë‹¤ì‹œí•˜ê¸°
            </button>

            <!-- Sentence Counter -->
            <p class="text-center mt-2" style="color: var(--primary); font-weight: 600;">
                <span id="currentIndex">1</span> / <span id="totalCount">5</span> ë¬¸ì¥
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="prevSentence()">ì´ì „</button>
            <button class="btn btn-primary" onclick="nextSentence()" id="nextBtn">ë‹¤ìŒ</button>
        </div>
    </div>

    <script src="../js/supabase.js"></script>
    <script src="../js/tts.js"></script>
    <script src="../js/speech.js"></script>
    <script>
        let sentences = [];
        let currentIndex = 0;
        let isRecording = false;

        // Audio Visualizer variables
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let audioStream = null;
        let animationId = null;

        // Audio visualizer functions
        async function startAudioVisualizer() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                microphone = audioContext.createMediaStreamSource(audioStream);
                microphone.connect(analyser);

                const container = document.getElementById('audioLevelContainer');
                container.classList.remove('hidden');
                container.style.display = 'flex';

                const bars = container.querySelectorAll('.audio-bar');
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function updateBars() {
                    analyser.getByteFrequencyData(dataArray);

                    // Get average volume
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;

                    bars.forEach((bar, index) => {
                        // Create wave effect with slight offset for each bar
                        const offset = Math.sin(Date.now() / 100 + index) * 5;
                        // Increased multiplier (40 -> 60) for better visibility
                        const height = Math.max(4, (average / 255) * 60 + offset);
                        bar.style.height = height + 'px';

                        // Color based on level - Lowered thresholds for better feedback
                        if (average > 50) { // Was 100
                            bar.style.background = 'var(--primary)';
                        } else if (average > 10) { // Was 30
                            bar.style.background = 'var(--primary-light)';
                        } else {
                            bar.style.background = 'var(--text-light)';
                        }
                    });

                    animationId = requestAnimationFrame(updateBars);
                }

                updateBars();
                console.log('ğŸµ Audio visualizer started');
            } catch (err) {
                console.error('Audio visualizer error:', err);
            }
        }

        function stopAudioVisualizer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
                audioContext = null;
            }

            const container = document.getElementById('audioLevelContainer');
            container.classList.add('hidden');

            console.log('ğŸµ Audio visualizer stopped');
        }

        document.addEventListener('DOMContentLoaded', () => {
            sentences = JSON.parse(sessionStorage.getItem('currentSentences')) || [];
            if (sentences.length === 0) {
                window.location.href = 'learn-step1.html';
                return;
            }

            document.getElementById('totalCount').textContent = sentences.length;
            updateSentence();

            // Check iOS Chrome - show Safari recommendation
            if (typeof getSpeechRecognitionInfo === 'function') {
                const info = getSpeechRecognitionInfo();
                if (info.recommendation) {
                    showToast('ğŸ’¡ ' + info.recommendation, 'warning', 5000);
                }

                // Samsung Internet Recommendation for Android Chrome
                const isAndroid = /Android/.test(navigator.userAgent);
                const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent) && !/SamsungBrowser/.test(navigator.userAgent);
                const isSamsungDevice = /Samsung|SM-|Galaxy/i.test(navigator.userAgent);

                if (isAndroid && isChrome && isSamsungDevice) {
                    setTimeout(() => {
                        showToast('ğŸ’¡ ìŒì„± ì¸ì‹ì´ ì˜ ì•ˆ ë˜ë©´ "ì‚¼ì„± ì¸í„°ë„·" ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.', 'info', 6000);
                    }, 1000);
                }
            }
        });

        function updateSentence() {
            const s = sentences[currentIndex];
            document.getElementById('sentenceKr').textContent = s.kr;
            document.getElementById('sentenceEn').textContent = s.en;
            document.getElementById('currentIndex').textContent = currentIndex + 1;

            // Reset UI state
            document.getElementById('accuracyDisplay').classList.add('hidden');
            document.getElementById('comparisonResult').classList.add('hidden');
            document.getElementById('recordHint').textContent = 'ë²„íŠ¼ì„ ëˆŒëŸ¬ ë§í•˜ì„¸ìš”';
            document.getElementById('recordHint').classList.remove('hidden');

            // Show big record button, hide retry button
            document.getElementById('recordBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.add('hidden');

            // Update next button text
            const nextBtn = document.getElementById('nextBtn');
            if (currentIndex === sentences.length - 1) {
                nextBtn.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ â†’';
            } else {
                nextBtn.textContent = 'ë‹¤ìŒ';
            }
        }

        async function playTTS() {
            const btn = document.getElementById('ttsBtn');
            const originalBg = btn.style.background;
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';

            try {
                await tts.speak(sentences[currentIndex].en, { rate: 0.85 });
            } catch (e) {
                console.error('TTS Error:', e);
            }

            btn.style.background = originalBg || 'var(--primary-pale)';
            btn.style.color = 'var(--primary)';
        }

        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const retryBtn = document.getElementById('retryBtn');
            const hint = document.getElementById('recordHint');

            if (!isRecording) {
                // Start recording
                isRecording = true;

                // Show record button (in case coming from retry button)
                btn.classList.remove('hidden');
                retryBtn.classList.add('hidden');
                hint.classList.remove('hidden');

                btn.classList.add('recording');
                btn.innerHTML = '<i class="ti ti-player-stop" style="font-size: 2rem;"></i>';
                hint.textContent = 'ë§í•˜ê³  ìˆì–´ìš”... ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¤‘ì§€';

                // Try to start both Visualizer and Recognition
                // On Android, this might conflict. If so, we'll retry without visualizer.

                let visualizerStarted = false;
                try {
                    await startAudioVisualizer();
                    visualizerStarted = true;
                } catch (e) {
                    console.warn('Visualizer start failed:', e);
                }

                // Hide previous results
                document.getElementById('accuracyDisplay').classList.add('hidden');
                document.getElementById('comparisonResult').classList.add('hidden');

                // Start speech recognition function
                const startRecognition = (retryWithoutVisualizer = false) => {
                    if (typeof startSpeechRecognition === 'function') {
                        startSpeechRecognition(sentences[currentIndex].en, (result) => {
                            // Check for specific error that implies audio conflict
                            if (result.error && !retryWithoutVisualizer && visualizerStarted) {
                                const conflictErrors = ['audio-capture', 'not-allowed', 'service-not-allowed'];
                                if (conflictErrors.includes(result.error)) {
                                    console.log('âš ï¸ Potential audio conflict detected. Retrying without visualizer...');
                                    stopAudioVisualizer(); // Kill visualizer
                                    visualizerStarted = false;

                                    // Retry immediately
                                    // Reset UI state implicitly by just calling start again?
                                    // We need to restart the recognition
                                    setTimeout(() => startRecognition(true), 500);
                                    return;
                                }
                            }

                            if (result.error) {
                                showError(result.errorMessage || 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            } else {
                                showAccuracy(result.accuracy, result.transcript);
                            }
                            stopRecordingUI();
                        }, { skipPermissionCheck: visualizerStarted }); // Skip check if visualizer handled it
                    } else {
                        showError('ìŒì„±ì¸ì‹ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        stopRecordingUI();
                    }
                };

                startRecognition(false);

            } else {
                // Stop recording
                if (typeof stopSpeechRecognition === 'function') {
                    stopSpeechRecognition();
                }
                stopRecordingUI();
            }
        }

        function stopRecordingUI() {
            // Stop audio visualizer
            stopAudioVisualizer();

            const btn = document.getElementById('recordBtn');
            const retryBtn = document.getElementById('retryBtn');
            const hint = document.getElementById('recordHint');

            isRecording = false;
            btn.classList.remove('recording');
            btn.innerHTML = '<i class="ti ti-microphone" style="font-size: 2rem;"></i>';

            // Hide big button, show small retry button
            btn.classList.add('hidden');
            retryBtn.classList.remove('hidden');
            retryBtn.style.display = 'flex';
            hint.classList.add('hidden');
        }

        function showAccuracy(accuracy, transcript) {
            const display = document.getElementById('accuracyDisplay');
            const value = document.getElementById('accuracyValue');
            const circle = display.querySelector('.accuracy-circle');
            const comparisonDiv = document.getElementById('comparisonResult');

            display.classList.remove('hidden');
            value.textContent = accuracy + '%';
            circle.style.setProperty('--accuracy', accuracy);

            // Save accuracy to learningProgress
            const progress = JSON.parse(sessionStorage.getItem('learningProgress') || '{"accuracyScores": []}');
            progress.accuracyScores = progress.accuracyScores || [];
            progress.accuracyScores.push(accuracy);
            sessionStorage.setItem('learningProgress', JSON.stringify(progress));

            // Show comparison with highlighted differences
            if (transcript) {
                const targetText = sentences[currentIndex].en;
                const comparisonHtml = compareWords(targetText, transcript);
                comparisonDiv.innerHTML = comparisonHtml;
                comparisonDiv.classList.remove('hidden');
            }
        }

        // Compare target and spoken words, highlight differences
        function compareWords(target, spoken) {
            const targetWords = target.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const originalTargetWords = target.replace(/[^\w\s]/g, '').split(/\s+/);
            const originalSpokenWords = spoken.replace(/[^\w\s]/g, '').split(/\s+/);

            // Build target line with highlights
            let resultHtml = '<div><strong style="color: var(--text-gray);">ì •ë‹µ:</strong> ';
            for (let i = 0; i < originalTargetWords.length; i++) {
                const word = originalTargetWords[i];
                const wordLower = word.toLowerCase();

                if (spokenWords.includes(wordLower)) {
                    resultHtml += `<span style="color: #22C55E; font-weight: 600;">${word}</span> `;
                } else {
                    resultHtml += `<span style="color: #EF4444; font-weight: 600; text-decoration: underline;">${word}</span> `;
                }
            }
            resultHtml += '</div>';

            // Build spoken line with highlights (show extra words in orange)
            resultHtml += '<div style="margin-top: 8px;"><strong style="color: var(--text-gray);">ë‚´ ë°œìŒ:</strong> ';
            for (let i = 0; i < originalSpokenWords.length; i++) {
                const word = originalSpokenWords[i];
                const wordLower = word.toLowerCase();

                if (targetWords.includes(wordLower)) {
                    resultHtml += `<span style="color: #22C55E;">${word}</span> `;
                } else {
                    // Extra word not in target - show in orange with strikethrough
                    resultHtml += `<span style="color: #F59E0B; text-decoration: line-through;">${word}</span> `;
                }
            }
            resultHtml += '</div>';

            return resultHtml;
        }

        function showError(message) {
            const display = document.getElementById('accuracyDisplay');
            const hint = document.getElementById('recordHint');

            display.classList.add('hidden');
            hint.innerHTML = '<span style="color: #e53935;">' + message + '</span>';
        }

        function prevSentence() {
            if (currentIndex > 0) {
                currentIndex--;
                updateSentence();
            }
        }

        function nextSentence() {
            if (currentIndex < sentences.length - 1) {
                currentIndex++;
                updateSentence();
            } else {
                // Go to next step
                window.location.href = 'learn-step3.html';
            }
        }
    </script>
</body>

</html>